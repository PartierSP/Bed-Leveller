' Gambas class file

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btOK_Click()

  Dim hSettings As Settings

  'Check if Margin value is sane
  If (sbMargin.Value >= sbBedDepth.Value) Or (sbMargin.Value >= sbBedWidth.Value) Then 
    Message("Margin must be smaller then Bed Width and Bed Depth")
    Goto EndSub
  Endif

  With FMain
    'Set settings
    .iBedSizeX = sbBedWidth.Value
    .iBedSizeY = sbBedDepth.Value
    .iMargin = sbMargin.Value
    .iRapidPlane = sbRapidPlane.Value
    .iCleanHeight = sbCleanHeight.Value
    .sCleanLoc = cbCleanLoc.Text
    .fRetraction = sbRetraction.Value
    .fShim = sbShim.Value
    .iBedTemp = sbBedTemperature.Value
    .iHETemp = sbHETemperature.Value
    .sPort = tbPort.Text
    .iBaud = Val(cbBaud.Text)
    .iDataBits = Val(cbDataBits.Text)
    .iStopBits = Val(cbStopBits.Text)
    .sParity = cbParity.Text
    .sFlowControl = cbFlowControl.Text
    .sInitialization[1] = tbInitialization1.Text
    .sInitialization[2] = tbInitialization2.Text
    .sInitialization[3] = tbInitialization3.Text
    .sHome = tbHome.Text
    .sRapidMove = tbRapid.Text
    .sLinearMove = tbLinear.Text
    .sSetBedTemp = tbSetBedTemp.Text
    .sBedTempPrefix = tbBedTempPrefix.Text
    .sSetHETemp = tbSetHETemp.Text
    .sHETempPrefix = tbHETempPrefix.Text
    .sGetTemperatures = tbGetTemperatures.Text
    .sGetPosition = tbGetPosition.Text
    .sDwell = tbDwell.Text
    .sMessage = tbMessage.Text
    .sAbsolute = tbAbsol.Text
    .sRelative = tbRelative.Text
    .iMaxJogSpeed = sbMaxJogSpeed.Value

    'Save settings to config
    hSettings = New Settings(.sConfigLoc &/ .sConfigName)

    hSettings["BedSize/BedSizeX"] = .iBedSizeX
    hSettings["BedSize/BedSizeY"] = .iBedSizeY

    hSettings["Post/Init1"] = .sInitialization[1]
    hSettings["Post/Init2"] = .sInitialization[2]
    hSettings["Post/Init3"] = .sInitialization[3]
    hSettings["Post/Home"] = .sHome
    hSettings["Post/RapidMove"] = .sRapidMove
    hSettings["Post/Linear"] = .sLinearMove
    hSettings["Post/SetBedTemp"] = .sSetBedTemp
    hSettings["Post/BedTempPrefix"] = .sBedTempPrefix
    hSettings["Post/SetHETemp"] = .sSetHETemp
    hSettings["Post/HETempPrefix"] = .sHETempPrefix
    hSettings["Post/GetTemperatures"] = .sGetTemperatures
    hSettings["Post/GetPosition"] = .sGetPosition
    hSettings["Post/Dwell"] = .sDwell
    hSettings["Post/Message"] = .sMessage
    hSettings["Post/Absolute"] = .sAbsolute
    hSettings["Post/Relative"] = .sRelative

    hSettings["Locations/Margin"] = .iMargin
    hSettings["Locations/RapidPlane"] = .iRapidPlane
    hSettings["Locations/Shim"] = .fShim
    hSettings["Locations/BedTemp"] = .iBedTemp
    hSettings["Locations/HETemp"] = .iHETemp
    hSettings["Locations/CleanHeight"] = .iCleanHeight
    hSettings["Locations/CleanLoc"] = .sCleanLoc
    hSettings["Locations/Retraction"] = .fRetraction
    hSettings["Locations/MaxJogSpeed"] = .iMaxJogSpeed
  
    hSettings["Communications/Port"] = .sPort
    hSettings["Communications/Baud"] = .iBaud
    hSettings["Communications/DataBits"] = .iDataBits
    hSettings["Communications/StopBits"] = .iStopBits
    hSettings["Communications/Parity"] = .sParity
    hSettings["Communications/FlowControl"] = .sFlowControl

    hSettings["System/FirstRun"] = False

    'Write settings to disk early in case this is a First Run.
    hSettings.Save

    'Update location button text
    .UpdateButtonNames

    'Check if this is a First Run.  If so, re-initialize start up to get communitations working.
    If .bFirstRun = True Then 
      .bFirstRun = False
      .Form_Open()
    Endif

  End With

  Me.Close

  EndSub:

End

Public Sub btCancel_Click()

  Me.Close

End

Public Sub Form_Open()

  Dim sBaudRates As New String[7]
  Dim sCleanLoc As New String[4]
  Dim sDataBits As New String[2]
  Dim sStopBits As New String[3]
  Dim sParity As New String[3]
  Dim sFlowControls As New String[4]
  Dim sAxis As New String[7]
  Dim hSettings As Settings

  'Retrieve Setting form settings.
  hSettings = New Settings(FMain.sConfigLoc &/ FMain.sConfigName)
  hSettings.Read(Me, "SettingForm")

  'Fill in Combo Boxes
  sCleanLoc = ["Home", "Left", "Middle", "Right"]
  cbCleanLoc.List = sCleanLoc

  sBaudRates = ["1200", "2400", "4800", "9600", "28800", "57600", "115200"]
  cbBaud.List = sBaudRates

  sDataBits = ["7", "8"]
  cbDataBits.List = sDataBits

  sStopBits = ["1", "2", "3"]
  cbStopBits.List = sStopBits

  sParity = ["None", "Even", "Odd"]
  cbParity.List = sParity

  sFlowControls = ["None", "Hardware", "Software", "Both"]
  cbFlowControl.List = sFlowControls
  
  sAxis = ["Axis 0", "Axis 1", "Axis 2", "Axis 3", "Axis 4", "Axis 5", "None"]
  cbAxisX.List = sAxis

  'Set the forms control values.
  With FMain
    sbBedWidth.Value = .iBedSizeX
    sbBedDepth.Value = .iBedSizeY
    sbMargin.Value = .iMargin
    sbRapidPlane.Value = .iRapidPlane
    sbShim.Value = .fShim
    sbBedTemperature.Value = .iBedTemp
    sbHETemperature.Value = .iHETemp
    sbCleanHeight.Text = .iCleanHeight
    cbCleanLoc.Text = .sCleanLoc
    sbRetraction.Value = .fRetraction
    tbPort.Text = .sPort
    cbBaud.Text = .iBaud
    cbDataBits.Text = .iDataBits
    cbStopBits.Text = .iStopBits
    cbParity.Text = .sParity
    cbFlowControl.Text = .sFlowControl
    tbInitialization1.Text = FMain.sInitialization[1]
    tbInitialization2.Text = FMain.sInitialization[2]
    tbInitialization3.Text = FMain.sInitialization[3]
    tbHome.Text = .sHome
    tbRapid.Text = .sRapidMove
    tbLinear.Text = .sLinearMove
    tbSetBedTemp.Text = .sSetBedTemp
    tbBedTempPrefix.Text = .sBedTempPrefix
    tbSetHETemp.Text = .sSetHETemp
    tbHETempPrefix.Text = .sHETempPrefix
    tbGetTemperatures.Text = .sGetTemperatures
    tbGetPosition.Text = .sGetPosition
    tbDwell.Text = .sDwell
    tbMessage.Text = .sMessage
    tbAbsol.Text = .sAbsolute
    tbRelative.Text = .sRelative
    sbMaxJogSpeed.Value = .iMaxJogSpeed
  End With

End

Public Sub Form_Close()

  Dim hSettings As Settings

  'Save Setting form settings.
  hSettings = New Settings(FMain.sConfigLoc &/ FMain.sConfigName)
  hSettings.Write(Me, "SettingForm")

End

Public Sub TabStrip1_Click()

  If TabStrip1.Index = 3 Then
    'disable Jog mode when adjusting joystick
    FMain.tgbjog.Value = False
  Endif

End

Public Sub tgbDetectX_Click()

  

End
